AWSTemplateFormatVersion: '2010-09-09'
Description: 'Quantum Hyper Search Production Infrastructure'

Parameters:
  InstanceType:
    Type: String
    Default: c5.large
    Description: EC2 instance type for application servers
  
  MinInstances:
    Type: Number
    Default: 2
    Description: Minimum number of instances
  
  MaxInstances:
    Type: Number
    Default: 10
    Description: Maximum number of instances

Resources:
  # VPC
  QuantumVPC:
    Type: AWS::EC2::VPC
    Properties:
      CidrBlock: 10.0.0.0/16
      EnableDnsHostnames: true
      EnableDnsSupport: true
      Tags:
        - Key: Name
          Value: quantum-hyper-search-vpc

  # Internet Gateway
  QuantumIGW:
    Type: AWS::EC2::InternetGateway
    Properties:
      Tags:
        - Key: Name
          Value: quantum-internet-gateway

  # VPC Gateway Attachment
  QuantumVPCGatewayAttachment:
    Type: AWS::EC2::VPCGatewayAttachment
    Properties:
      VpcId: !Ref QuantumVPC
      InternetGatewayId: !Ref QuantumIGW

  # Public Subnets
  PublicSubnet1:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref QuantumVPC
      CidrBlock: 10.0.1.0/24
      AvailabilityZone: !Select [0, !GetAZs '']
      MapPublicIpOnLaunch: true
      Tags:
        - Key: Name
          Value: quantum-public-subnet-1

  PublicSubnet2:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref QuantumVPC
      CidrBlock: 10.0.2.0/24
      AvailabilityZone: !Select [1, !GetAZs '']
      MapPublicIpOnLaunch: true
      Tags:
        - Key: Name
          Value: quantum-public-subnet-2

  # Application Load Balancer
  QuantumALB:
    Type: AWS::ElasticLoadBalancingV2::LoadBalancer
    Properties:
      Name: quantum-hyper-search-alb
      Type: application
      Scheme: internet-facing
      SecurityGroups:
        - !Ref ALBSecurityGroup
      Subnets:
        - !Ref PublicSubnet1
        - !Ref PublicSubnet2

  # Security Groups
  ALBSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: Security group for Quantum ALB
      VpcId: !Ref QuantumVPC
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 80
          ToPort: 80
          CidrIp: 0.0.0.0/0
        - IpProtocol: tcp
          FromPort: 443
          ToPort: 443
          CidrIp: 0.0.0.0/0

  InstanceSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: Security group for Quantum instances
      VpcId: !Ref QuantumVPC
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 8000
          ToPort: 8000
          SourceSecurityGroupId: !Ref ALBSecurityGroup

Outputs:
  LoadBalancerDNS:
    Description: DNS name of the load balancer
    Value: !GetAtt QuantumALB.DNSName
    Export:
      Name: QuantumLoadBalancerDNS

  VPCId:
    Description: VPC ID
    Value: !Ref QuantumVPC
    Export:
      Name: QuantumVPCId
